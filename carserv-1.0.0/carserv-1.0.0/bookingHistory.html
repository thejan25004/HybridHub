<!--<!DOCTYPE html>-->
<!--<html lang="en">-->
<!--<head>-->
<!--    <meta charset="UTF-8">-->
<!--    <title>Booking History</title>-->
<!--    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">-->
<!--    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>-->
<!--    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>-->
<!--</head>-->
<!--<body>-->

<!--<div class="container my-5">-->
<!--    <h2 class="text-center fw-bold mb-4">ðŸ“œ Booking History</h2>-->

<!--    &lt;!&ndash; Past Due Bookings List &ndash;&gt;-->
<!--    <div class="card shadow p-4">-->
<!--        <h4 class="text-primary">âŒ› Past Due Bookings</h4>-->
<!--        <div class="table-responsive">-->
<!--            <table class="table table-hover align-middle">-->
<!--                <thead class="table-dark">-->
<!--                <tr>-->
<!--                    <th>Booking ID</th>-->
<!--                    <th>Customer ID</th>-->
<!--                    <th>Service ID</th>-->
<!--                    <th>Booking Date</th>-->
<!--                    <th>Booking Time</th>-->
<!--                    <th>Status</th>-->
<!--                    <th>Actions</th>-->
<!--                </tr>-->
<!--                </thead>-->
<!--                <tbody id="pastDueBookingsTable">-->
<!--                &lt;!&ndash; Past due booking rows will be inserted dynamically &ndash;&gt;-->
<!--                </tbody>-->
<!--            </table>-->
<!--        </div>-->
<!--    </div>-->

<!--    &lt;!&ndash; Booking Details Modal &ndash;&gt;-->
<!--    <div class="modal fade" id="bookingDetailsModal" tabindex="-1" role="dialog" aria-labelledby="bookingDetailsModalLabel" aria-hidden="true">-->
<!--        <div class="modal-dialog modal-lg" role="document">-->
<!--            <div class="modal-content">-->
<!--                <div class="modal-header">-->
<!--                    <h5 class="modal-title" id="bookingDetailsModalLabel">Booking Details</h5>-->
<!--                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">-->
<!--                        <span aria-hidden="true">&times;</span>-->
<!--                    </button>-->
<!--                </div>-->
<!--                <div class="modal-body">-->
<!--                    <div class="row">-->
<!--                        <div class="col-md-6">-->
<!--                            <p><strong>Booking ID:</strong> <span id="modal-bookingId"></span></p>-->
<!--                            <p><strong>Customer ID:</strong> <span id="modal-customerId"></span></p>-->
<!--                            <p><strong>Service ID:</strong> <span id="modal-serviceId"></span></p>-->
<!--                            <p><strong>Technician ID:</strong> <span id="modal-technicianId"></span></p>-->
<!--                        </div>-->
<!--                        <div class="col-md-6">-->
<!--                            <p><strong>Booking Date:</strong> <span id="modal-bookingDate"></span></p>-->
<!--                            <p><strong>Booking Time:</strong> <span id="modal-bookingTime"></span></p>-->
<!--                            <p><strong>Mobile Number:</strong> <span id="modal-mobileNumber"></span></p>-->
<!--                            <p><strong>Current Status:</strong> <span id="modal-status" class="badge"></span></p>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                    <hr>-->
<!--                    <div class="form-group">-->
<!--                        <label for="updateStatusSelect"><b>Update Status:</b></label>-->
<!--                        <select class="form-control" id="updateStatusSelect">-->
<!--                            <option value="Completed">Completed</option>-->
<!--                            <option value="Cancelled">Cancelled</option>-->
<!--                            <option value="Extended">Extended</option>-->
<!--                        </select>-->
<!--                    </div>-->
<!--                    <div id="extensionForm" style="display: none;">-->
<!--                        <div class="form-group">-->
<!--                            <label for="extensionDate">New Date:</label>-->
<!--                            <input type="date" class="form-control" id="extensionDate">-->
<!--                        </div>-->
<!--                        <div class="form-group">-->
<!--                            <label for="extensionTime">New Time:</label>-->
<!--                            <input type="time" class="form-control" id="extensionTime">-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </div>-->
<!--                <div class="modal-footer">-->
<!--                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>-->
<!--                    <button type="button" class="btn btn-primary" id="saveStatusButton">Save Status</button>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->

<!--    &lt;!&ndash; Response Message &ndash;&gt;-->
<!--    <div id="responseMessage" class="mt-3 text-center fw-bold"></div>-->
<!--</div>-->

<!--<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>-->
<!--<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>-->
<!--<script>-->
<!--    let token = localStorage.getItem("authToken");-->
<!--    let bookings = [];-->
<!--    let selectedBookingId = null;-->

<!--    // Function to check if a booking is past due-->
<!--    function isPastDue(bookingDate, bookingTime) {-->
<!--        const now = new Date();-->
<!--        const booking = new Date(bookingDate + 'T' + bookingTime);-->
<!--        return booking < now;-->
<!--    }-->

<!--    // Function to fetch all bookings and filter past due ones-->
<!--    function fetchPastDueBookings() {-->
<!--        fetch("http://localhost:8080/api/v1/booking/getAll", {-->
<!--            method: 'GET',-->
<!--            headers: {-->
<!--                'Authorization': `Bearer ${token}`-->
<!--            }-->
<!--        })-->
<!--            .then(response => response.json())-->
<!--            .then(data => {-->
<!--                bookings = data;-->
<!--                const pastDueBookings = data.filter(booking =>-->
<!--                    isPastDue(booking.bookingDate, booking.bookingTime)-->
<!--                );-->

<!--                displayPastDueBookings(pastDueBookings);-->
<!--            })-->
<!--            .catch(error => {-->
<!--                console.error("Error fetching bookings:", error);-->
<!--                Swal.fire("Error!", "Failed to fetch bookings.", "error");-->
<!--            });-->
<!--    }-->

<!--    // Function to display past due bookings-->
<!--    function displayPastDueBookings(pastDueBookings) {-->
<!--        const tableBody = document.getElementById("pastDueBookingsTable");-->
<!--        tableBody.innerHTML = "";-->

<!--        if (pastDueBookings.length === 0) {-->
<!--            tableBody.innerHTML = `<tr><td colspan="7" class="text-center">No past due bookings found</td></tr>`;-->
<!--            return;-->
<!--        }-->

<!--        // Check for bookings with status in the database-->
<!--        fetch("http://localhost:8080/api/v1/booking-history/getAll", {-->
<!--            method: 'GET',-->
<!--            headers: {-->
<!--                'Authorization': `Bearer ${token}`-->
<!--            }-->
<!--        })-->
<!--            .then(response => response.json())-->
<!--            .then(historyData => {-->
<!--                // Create a map of booking IDs to their status-->
<!--                const statusMap = {};-->
<!--                historyData.forEach(history => {-->
<!--                    statusMap[history.bookingId] = history.status;-->
<!--                });-->

<!--                // Populate the table-->
<!--                pastDueBookings.forEach(booking => {-->
<!--                    // Get status from database history or default to "Pending"-->
<!--                    const bookingStatus = statusMap[booking.bookingId] || "Pending";-->

<!--                    const row = document.createElement("tr");-->
<!--                    row.innerHTML = `-->
<!--                        <td>${booking.bookingId}</td>-->
<!--                        <td>${booking.customerId}</td>-->
<!--                        <td>${booking.serviceId}</td>-->
<!--                        <td>${booking.bookingDate}</td>-->
<!--                        <td>${booking.bookingTime.slice(0, 5)}</td>-->
<!--                        <td>-->
<!--                            <span class="badge badge-${getStatusBadgeClass(bookingStatus)}">${bookingStatus}</span>-->
<!--                        </td>-->
<!--                        <td>-->
<!--                            <button class="btn btn-sm btn-primary view-details" data-id="${booking.bookingId}">-->
<!--                                Update Status-->
<!--                            </button>-->
<!--                        </td>-->
<!--                    `;-->

<!--                    tableBody.appendChild(row);-->
<!--                });-->

<!--                // Add event listeners to view details buttons-->
<!--                document.querySelectorAll('.view-details').forEach(button => {-->
<!--                    button.addEventListener('click', function() {-->
<!--                        const bookingId = this.getAttribute('data-id');-->
<!--                        openBookingDetailsModal(bookingId, statusMap[bookingId] || "Pending");-->
<!--                    });-->
<!--                });-->
<!--            })-->
<!--            .catch(error => {-->
<!--                console.error("Error fetching booking history:", error);-->

<!--                // Fallback to display without history data-->
<!--                pastDueBookings.forEach(booking => {-->
<!--                    const row = document.createElement("tr");-->
<!--                    row.innerHTML = `-->
<!--                        <td>${booking.bookingId}</td>-->
<!--                        <td>${booking.customerId}</td>-->
<!--                        <td>${booking.serviceId}</td>-->
<!--                        <td>${booking.bookingDate}</td>-->
<!--                        <td>${booking.bookingTime.slice(0, 5)}</td>-->
<!--                        <td>-->
<!--                            <span class="badge badge-secondary">Pending</span>-->
<!--                        </td>-->
<!--                        <td>-->
<!--                            <button class="btn btn-sm btn-primary view-details" data-id="${booking.bookingId}">-->
<!--                                Update Status-->
<!--                            </button>-->
<!--                        </td>-->
<!--                    `;-->

<!--                    tableBody.appendChild(row);-->
<!--                });-->

<!--                // Add event listeners to view details buttons-->
<!--                document.querySelectorAll('.view-details').forEach(button => {-->
<!--                    button.addEventListener('click', function() {-->
<!--                        const bookingId = this.getAttribute('data-id');-->
<!--                        openBookingDetailsModal(bookingId, "Pending");-->
<!--                    });-->
<!--                });-->
<!--            });-->
<!--    }-->

<!--    // Function to get Bootstrap badge class based on status-->
<!--    function getStatusBadgeClass(status) {-->
<!--        switch(status) {-->
<!--            case "Completed": return "success";-->
<!--            case "Cancelled": return "danger";-->
<!--            case "Extended": return "warning";-->
<!--            default: return "secondary";-->
<!--        }-->
<!--    }-->

<!--    // Function to open booking details modal-->
<!--    function openBookingDetailsModal(bookingId, currentStatus) {-->
<!--        selectedBookingId = bookingId;-->
<!--        const booking = bookings.find(b => b.bookingId == bookingId);-->

<!--        if (!booking) {-->
<!--            Swal.fire("Error!", "Booking details not found.", "error");-->
<!--            return;-->
<!--        }-->

<!--        // Populate modal with booking details-->
<!--        document.getElementById("modal-bookingId").textContent = booking.bookingId;-->
<!--        document.getElementById("modal-customerId").textContent = booking.customerId;-->
<!--        document.getElementById("modal-serviceId").textContent = booking.serviceId;-->
<!--        document.getElementById("modal-technicianId").textContent = booking.technicianId || "None";-->
<!--        document.getElementById("modal-bookingDate").textContent = booking.bookingDate;-->
<!--        document.getElementById("modal-bookingTime").textContent = booking.bookingTime.slice(0, 5);-->
<!--        document.getElementById("modal-mobileNumber").textContent = booking.mobileNumber;-->

<!--        // Set current status-->
<!--        const statusElement = document.getElementById("modal-status");-->
<!--        statusElement.textContent = currentStatus;-->
<!--        statusElement.className = `badge badge-${getStatusBadgeClass(currentStatus)}`;-->

<!--        // Set default selected option-->
<!--        document.getElementById("updateStatusSelect").value = currentStatus;-->

<!--        // Show extension form if Extended is selected-->
<!--        const statusSelect = document.getElementById("updateStatusSelect");-->
<!--        const extensionForm = document.getElementById("extensionForm");-->

<!--        // Remove any existing event listeners-->
<!--        const newStatusSelect = statusSelect.cloneNode(true);-->
<!--        statusSelect.parentNode.replaceChild(newStatusSelect, statusSelect);-->

<!--        // Add event listener to the new select element-->
<!--        newStatusSelect.addEventListener('change', function() {-->
<!--            extensionForm.style.display = this.value === "Extended" ? "block" : "none";-->

<!--            if (this.value === "Extended") {-->
<!--                // Set default extension date to one week from original booking-->
<!--                const originalDate = new Date(booking.bookingDate);-->
<!--                const newDate = new Date(originalDate);-->
<!--                newDate.setDate(newDate.getDate() + 7);-->

<!--                document.getElementById("extensionDate").value = newDate.toISOString().split('T')[0];-->
<!--                document.getElementById("extensionTime").value = booking.bookingTime.slice(0, 5);-->
<!--            }-->
<!--        });-->

<!--        // Trigger initial change event-->
<!--        extensionForm.style.display = newStatusSelect.value === "Extended" ? "block" : "none";-->
<!--        if (newStatusSelect.value === "Extended") {-->
<!--            const originalDate = new Date(booking.bookingDate);-->
<!--            const newDate = new Date(originalDate);-->
<!--            newDate.setDate(newDate.getDate() + 7);-->

<!--            document.getElementById("extensionDate").value = newDate.toISOString().split('T')[0];-->
<!--            document.getElementById("extensionTime").value = booking.bookingTime.slice(0, 5);-->
<!--        }-->

<!--        // Add event listener to save button-->
<!--        const saveButton = document.getElementById("saveStatusButton");-->
<!--        const newSaveButton = saveButton.cloneNode(true);-->
<!--        saveButton.parentNode.replaceChild(newSaveButton, saveButton);-->

<!--        newSaveButton.onclick = function() {-->
<!--            updateBookingStatus(booking);-->
<!--        };-->

<!--        // Show modal-->
<!--        $('#bookingDetailsModal').modal('show');-->
<!--    }-->

<!--    // Function to update booking status-->
<!--    function updateBookingStatus(booking) {-->
<!--        const newStatus = document.getElementById("updateStatusSelect").value;-->
<!--        let updateData = {-->
<!--            bookingId: booking.bookingId,-->
<!--            customerId: booking.customerId,-->
<!--            status: newStatus,-->
<!--            updateDate: new Date().toISOString().split('T')[0]-->
<!--        };-->

<!--        // If Extended status, update booking with new date and time-->
<!--        if (newStatus === "Extended") {-->
<!--            const newDate = document.getElementById("extensionDate").value;-->
<!--            const newTime = document.getElementById("extensionTime").value + ":00";-->

<!--            if (!newDate || !newTime) {-->
<!--                Swal.fire("Error!", "Please provide new date and time for the extension.", "error");-->
<!--                return;-->
<!--            }-->

<!--            // First update the original booking-->
<!--            const bookingUpdateData = {-->
<!--                bookingId: booking.bookingId,-->
<!--                customerId: booking.customerId,-->
<!--                technicianId: booking.technicianId,-->
<!--                serviceId: booking.serviceId,-->
<!--                bookingDate: newDate,-->
<!--                bookingTime: newTime,-->
<!--                mobileNumber: booking.mobileNumber-->
<!--            };-->

<!--            fetch("http://localhost:8080/api/v1/booking/update", {-->
<!--                method: "PUT",-->
<!--                headers: {-->
<!--                    "Content-Type": "application/json",-->
<!--                    "Authorization": `Bearer ${token}`-->
<!--                },-->
<!--                body: JSON.stringify(bookingUpdateData)-->
<!--            })-->
<!--                .then(response => {-->
<!--                    if (!response.ok) {-->
<!--                        throw new Error("Failed to update booking date/time");-->
<!--                    }-->
<!--                    return response.text();-->
<!--                })-->
<!--                .then(() => {-->
<!--                    // Now save the history record-->
<!--                    return saveBookingHistory(updateData);-->
<!--                })-->
<!--                .then(() => {-->
<!--                    Swal.fire("Success!", `Booking extended to ${newDate}`, "success");-->
<!--                    $('#bookingDetailsModal').modal('hide');-->
<!--                    fetchPastDueBookings(); // Refresh the list-->
<!--                })-->
<!--                .catch(error => {-->
<!--                    console.error("Error updating extended booking:", error);-->
<!--                    Swal.fire("Error!", "Failed to extend booking.", "error");-->
<!--                });-->
<!--        } else {-->
<!--            // For other statuses, just save the history-->
<!--            saveBookingHistory(updateData)-->
<!--                .then(() => {-->
<!--                    Swal.fire("Success!", `Booking status updated to ${newStatus}`, "success");-->
<!--                    $('#bookingDetailsModal').modal('hide');-->
<!--                    fetchPastDueBookings(); // Refresh the list-->
<!--                })-->
<!--                .catch(error => {-->
<!--                    console.error("Error saving booking history:", error);-->
<!--                    Swal.fire("Error!", "Failed to update booking status.", "error");-->
<!--                });-->
<!--        }-->
<!--    }-->

<!--    // Function to save booking history to database-->
<!--    function saveBookingHistory(historyData) {-->
<!--        return fetch("http://localhost:8080/api/v1/booking-history/save", {-->
<!--            method: "POST",-->
<!--            headers: {-->
<!--                "Content-Type": "application/json",-->
<!--                "Authorization": `Bearer ${token}`-->
<!--            },-->
<!--            body: JSON.stringify(historyData)-->
<!--        })-->
<!--            .then(response => {-->
<!--                if (!response.ok) {-->
<!--                    throw new Error("Failed to save booking history");-->
<!--                }-->
<!--                return response.text();-->
<!--            });-->
<!--    }-->

<!--    // Load past due bookings on page load-->
<!--    window.onload = fetchPastDueBookings;-->
<!--</script>-->
<!--</body>-->
<!--</html>-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking History</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1200px;
        }
        .back-to-dashboard {
            display: flex;
            align-items: center;
            color: #4CAF50;
            text-decoration: none;
            font-size: 16px;
            padding: 10px;
            border-radius: 4px;
            background-color: #f1f1f1;
            border: 1px solid #ddd;
            margin-bottom: 20px;
            width: fit-content;
        }
        .back-to-dashboard:hover {
            background-color: #e7f7e5;
            color: #388e3c;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            margin-bottom: 20px;
            border: none;
        }
        .status-card {
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .status-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        .status-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background-color: inherit;
        }
        .active-card {
            border: 2px solid #007bff;
            transform: translateY(-5px);
        }
        .card-body {
            padding: 1.5rem;
        }
        .card-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
        }
        .display-4 {
            font-weight: 700;
            font-size: 2.5rem;
        }
        .table {
            border-radius: 8px;
            overflow: hidden;
        }
        .table-dark th {
            background-color: #343a40;
            border-color: #454d55;
        }
        .btn {
            border-radius: 6px;
            padding: 0.375rem 0.75rem;
        }
        #bookingsTableTitle {
            margin-bottom: 1rem;
            color: #343a40;
            font-weight: 600;
        }
        .shadow {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
        }
        .card-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .modal-content {
            border-radius: 10px;
            border: none;
        }
        .modal-header {
            border-radius: 10px 10px 0 0;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        .modal-footer {
            border-radius: 0 0 10px 10px;
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }
        .badge {
            padding: 0.5em 0.8em;
            font-weight: 500;
        }
    </style>
</head>
<body>

<div class="container my-5">
    <a href="Admin.html" class="back-to-dashboard">
        <i class="fas fa-arrow-left me-2"></i> Back to Dashboard
    </a>

    <h2 class="mb-4">ðŸ“œ Booking History</h2>

    <!-- Status Summary Cards -->
    <div class="row mb-4" id="statusCards">
        <div class="col-md-3">
            <div class="card status-card bg-white" data-status="all">
                <div class="card-body text-center">
                    <i class="fas fa-clipboard-list card-icon text-primary"></i>
                    <h5 class="card-title">All Bookings</h5>
                    <div class="display-4 text-primary" id="allCount">0</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card status-card bg-success text-white" data-status="Completed">
                <div class="card-body text-center">
                    <i class="fas fa-check-circle card-icon"></i>
                    <h5 class="card-title">Completed</h5>
                    <div class="display-4" id="completedCount">0</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card status-card bg-danger text-white" data-status="Cancelled">
                <div class="card-body text-center">
                    <i class="fas fa-times-circle card-icon"></i>
                    <h5 class="card-title">Cancelled</h5>
                    <div class="display-4" id="cancelledCount">0</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card status-card bg-warning" data-status="Extended">
                <div class="card-body text-center">
                    <i class="fas fa-calendar-plus card-icon"></i>
                    <h5 class="card-title">Extended</h5>
                    <div class="display-4" id="extendedCount">0</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Past Due Bookings List -->
    <div class="card shadow p-4 mb-4">
        <h4 class="text-primary" id="bookingsTableTitle">
            <i class="fas fa-history me-2"></i> Past Due Bookings
        </h4>
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-dark">
                <tr>
                    <th>Booking ID</th>
                    <th>Customer ID</th>
                    <th>Service ID</th>
                    <th>Booking Date</th>
                    <th>Booking Time</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="pastDueBookingsTable">
                <!-- Past due booking rows will be inserted dynamically -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Response Message -->
    <div id="responseMessage" class="mt-3 text-center fw-bold"></div>
</div>

<!-- Booking Details Modal -->
<div class="modal fade" id="bookingDetailsModal" tabindex="-1" role="dialog" aria-labelledby="bookingDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookingDetailsModalLabel">
                    <i class="fas fa-info-circle me-2"></i> Booking Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong><i class="fas fa-bookmark me-2"></i>Booking ID:</strong> <span id="modal-bookingId"></span></p>
                        <p><strong><i class="fas fa-user me-2"></i>Customer ID:</strong> <span id="modal-customerId"></span></p>
                        <p><strong><i class="fas fa-cogs me-2"></i>Service ID:</strong> <span id="modal-serviceId"></span></p>
                        <p><strong><i class="fas fa-user-cog me-2"></i>Technician ID:</strong> <span id="modal-technicianId"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong><i class="fas fa-calendar-day me-2"></i>Booking Date:</strong> <span id="modal-bookingDate"></span></p>
                        <p><strong><i class="fas fa-clock me-2"></i>Booking Time:</strong> <span id="modal-bookingTime"></span></p>
                        <p><strong><i class="fas fa-mobile-alt me-2"></i>Mobile Number:</strong> <span id="modal-mobileNumber"></span></p>
                        <p><strong><i class="fas fa-tag me-2"></i>Current Status:</strong> <span id="modal-status" class="badge"></span></p>
                    </div>
                </div>
                <hr>
                <div class="form-group">
                    <label for="updateStatusSelect"><b><i class="fas fa-edit me-2"></i>Update Status:</b></label>
                    <select class="form-select" id="updateStatusSelect">
                        <option value="Completed">Completed</option>
                        <option value="Cancelled">Cancelled</option>
                        <option value="Extended">Extended</option>
                    </select>
                </div>
                <div id="extensionForm" class="mt-3" style="display: none;">
                    <div class="form-group mb-3">
                        <label for="extensionDate"><i class="fas fa-calendar-alt me-2"></i>New Date:</label>
                        <input type="date" class="form-control" id="extensionDate">
                    </div>
                    <div class="form-group">
                        <label for="extensionTime"><i class="fas fa-clock me-2"></i>New Time:</label>
                        <input type="time" class="form-control" id="extensionTime">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Close
                </button>
                <button type="button" class="btn btn-primary" id="saveStatusButton">
                    <i class="fas fa-save me-2"></i>Save Status
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let token = localStorage.getItem("authToken");
    let bookings = [];
    let pastDueBookings = [];
    let bookingStatusMap = {};
    let selectedBookingId = null;
    let currentFilter = "all";

    // Function to check if a booking is past due
    function isPastDue(bookingDate, bookingTime) {
        const now = new Date();
        const booking = new Date(bookingDate + 'T' + bookingTime);
        return booking < now;
    }

    // Function to fetch all bookings and filter past due ones
    function fetchPastDueBookings() {
        fetch("http://localhost:8080/api/v1/booking/getAll", {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
            .then(response => response.json())
            .then(data => {
                bookings = data;
                pastDueBookings = data.filter(booking =>
                    isPastDue(booking.bookingDate, booking.bookingTime)
                );

                // Now fetch booking history statuses
                fetchBookingStatuses();
            })
            .catch(error => {
                console.error("Error fetching bookings:", error);
                Swal.fire("Error!", "Failed to fetch bookings.", "error");
            });
    }

    // Function to fetch booking status history
    function fetchBookingStatuses() {
        fetch("http://localhost:8080/api/v1/booking-history/getAll", {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
            .then(response => response.json())
            .then(historyData => {
                // Create a map of booking IDs to their latest status
                bookingStatusMap = {};

                // Group history by booking ID
                const historyByBookingId = {};
                historyData.forEach(history => {
                    if (!historyByBookingId[history.bookingId]) {
                        historyByBookingId[history.bookingId] = [];
                    }
                    historyByBookingId[history.bookingId].push(history);
                });

                // Get the latest status for each booking
                for (const bookingId in historyByBookingId) {
                    const bookingHistories = historyByBookingId[bookingId];
                    const latestHistory = bookingHistories.reduce((latest, current) => {
                        return new Date(latest.updateDate) > new Date(current.updateDate) ? latest : current;
                    });
                    bookingStatusMap[bookingId] = latestHistory.status;
                }

                // Display bookings with their statuses
                displayBookings(pastDueBookings);
                updateStatusCounts();
            })
            .catch(error => {
                console.error("Error fetching booking history:", error);
                // Display bookings with default "Pending" status
                displayBookings(pastDueBookings);
                updateStatusCounts();
            });
    }

    // Function to update the status counts in the cards
    function updateStatusCounts() {
        let completedCount = 0;
        let cancelledCount = 0;
        let extendedCount = 0;

        pastDueBookings.forEach(booking => {
            const status = bookingStatusMap[booking.bookingId] || "Pending";
            if (status === "Completed") completedCount++;
            if (status === "Cancelled") cancelledCount++;
            if (status === "Extended") extendedCount++;
        });

        document.getElementById("allCount").textContent = pastDueBookings.length;
        document.getElementById("completedCount").textContent = completedCount;
        document.getElementById("cancelledCount").textContent = cancelledCount;
        document.getElementById("extendedCount").textContent = extendedCount;
    }

    // Function to display bookings with optional status filter
    function displayBookings(bookingsToDisplay, statusFilter = null) {
        const tableBody = document.getElementById("pastDueBookingsTable");
        const tableTitle = document.getElementById("bookingsTableTitle");
        tableBody.innerHTML = "";

        // Apply status filter if provided
        if (statusFilter && statusFilter !== "all") {
            bookingsToDisplay = bookingsToDisplay.filter(booking =>
                (bookingStatusMap[booking.bookingId] || "Pending") === statusFilter
            );
            tableTitle.innerHTML = `<i class="fas fa-filter me-2"></i> ${statusFilter} Bookings`;
        } else {
            tableTitle.innerHTML = '<i class="fas fa-history me-2"></i> Past Due Bookings';
        }

        // Update active card status
        document.querySelectorAll(".status-card").forEach(card => {
            card.classList.remove("active-card");
            if ((statusFilter && card.dataset.status === statusFilter) ||
                (!statusFilter && card.dataset.status === "all")) {
                card.classList.add("active-card");
            }
        });

        if (bookingsToDisplay.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="7" class="text-center">No bookings found</td></tr>`;
            return;
        }

        // Populate the table
        bookingsToDisplay.forEach(booking => {
            // Get status or default to "Pending"
            const bookingStatus = bookingStatusMap[booking.bookingId] || "Pending";

            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${booking.bookingId}</td>
                <td>${booking.customerId}</td>
                <td>${booking.serviceId}</td>
                <td>${booking.bookingDate}</td>
                <td>${booking.bookingTime.slice(0, 5)}</td>
                <td>
                    <span class="badge bg-${getStatusBadgeClass(bookingStatus)}">${bookingStatus}</span>
                </td>
                <td>
                    <button class="btn btn-sm btn-primary view-details" data-id="${booking.bookingId}">
                        <i class="fas fa-edit me-1"></i> Update Status
                    </button>
                </td>
            `;

            tableBody.appendChild(row);
        });

        // Add event listeners to view details buttons
        document.querySelectorAll('.view-details').forEach(button => {
            button.addEventListener('click', function() {
                const bookingId = this.getAttribute('data-id');
                openBookingDetailsModal(bookingId, bookingStatusMap[bookingId] || "Pending");
            });
        });
    }

    // Function to get Bootstrap badge class based on status
    function getStatusBadgeClass(status) {
        switch(status) {
            case "Completed": return "success";
            case "Cancelled": return "danger";
            case "Extended": return "warning";
            default: return "secondary";
        }
    }

    // Function to open booking details modal
    function openBookingDetailsModal(bookingId, currentStatus) {
        selectedBookingId = bookingId;
        const booking = bookings.find(b => b.bookingId == bookingId);

        if (!booking) {
            Swal.fire("Error!", "Booking details not found.", "error");
            return;
        }

        // Populate modal with booking details
        document.getElementById("modal-bookingId").textContent = booking.bookingId;
        document.getElementById("modal-customerId").textContent = booking.customerId;
        document.getElementById("modal-serviceId").textContent = booking.serviceId;
        document.getElementById("modal-technicianId").textContent = booking.technicianId || "None";
        document.getElementById("modal-bookingDate").textContent = booking.bookingDate;
        document.getElementById("modal-bookingTime").textContent = booking.bookingTime.slice(0, 5);
        document.getElementById("modal-mobileNumber").textContent = booking.mobileNumber;

        // Set current status
        const statusElement = document.getElementById("modal-status");
        statusElement.textContent = currentStatus;
        statusElement.className = `badge bg-${getStatusBadgeClass(currentStatus)}`;

        // Set default selected option
        document.getElementById("updateStatusSelect").value = currentStatus;

        // Show extension form if Extended is selected
        const statusSelect = document.getElementById("updateStatusSelect");
        const extensionForm = document.getElementById("extensionForm");

        // Remove any existing event listeners
        const newStatusSelect = statusSelect.cloneNode(true);
        statusSelect.parentNode.replaceChild(newStatusSelect, statusSelect);

        // Add event listener to the new select element
        newStatusSelect.addEventListener('change', function() {
            extensionForm.style.display = this.value === "Extended" ? "block" : "none";

            if (this.value === "Extended") {
                // Set default extension date to one week from original booking
                const originalDate = new Date(booking.bookingDate);
                const newDate = new Date(originalDate);
                newDate.setDate(newDate.getDate() + 7);

                document.getElementById("extensionDate").value = newDate.toISOString().split('T')[0];
                document.getElementById("extensionTime").value = booking.bookingTime.slice(0, 5);
            }
        });

        // Trigger initial change event
        extensionForm.style.display = newStatusSelect.value === "Extended" ? "block" : "none";
        if (newStatusSelect.value === "Extended") {
            const originalDate = new Date(booking.bookingDate);
            const newDate = new Date(originalDate);
            newDate.setDate(newDate.getDate() + 7);

            document.getElementById("extensionDate").value = newDate.toISOString().split('T')[0];
            document.getElementById("extensionTime").value = booking.bookingTime.slice(0, 5);
        }

        // Add event listener to save button
        const saveButton = document.getElementById("saveStatusButton");
        const newSaveButton = saveButton.cloneNode(true);
        saveButton.parentNode.replaceChild(newSaveButton, saveButton);

        newSaveButton.onclick = function() {
            updateBookingStatus(booking);
        };

        // Show modal
        const bookingModal = new bootstrap.Modal(document.getElementById('bookingDetailsModal'));
        bookingModal.show();
    }

    // Function to update booking status
    function updateBookingStatus(booking) {
        const newStatus = document.getElementById("updateStatusSelect").value;
        let updateData = {
            bookingId: booking.bookingId,
            customerId: booking.customerId,
            status: newStatus,
            updateDate: new Date().toISOString().split('T')[0]
        };

        // If Extended status, update booking with new date and time
        if (newStatus === "Extended") {
            const newDate = document.getElementById("extensionDate").value;
            const newTime = document.getElementById("extensionTime").value + ":00";

            if (!newDate || !newTime) {
                Swal.fire("Error!", "Please provide new date and time for the extension.", "error");
                return;
            }

            // First update the original booking
            const bookingUpdateData = {
                bookingId: booking.bookingId,
                customerId: booking.customerId,
                technicianId: booking.technicianId,
                serviceId: booking.serviceId,
                bookingDate: newDate,
                bookingTime: newTime,
                mobileNumber: booking.mobileNumber
            };

            fetch("http://localhost:8080/api/v1/booking/update", {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify(bookingUpdateData)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Failed to update booking date/time");
                    }
                    return response.text();
                })
                .then(() => {
                    // Now save the history record
                    return saveBookingHistory(updateData);
                })
                .then(() => {
                    // Update local status map for immediate UI update
                    bookingStatusMap[booking.bookingId] = newStatus;

                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: `Booking extended to ${newDate}`,
                        confirmButtonColor: '#28a745'
                    });

                    // Hide modal
                    const bookingModal = bootstrap.Modal.getInstance(document.getElementById('bookingDetailsModal'));
                    bookingModal.hide();

                    // Refresh the counts and display
                    updateStatusCounts();
                    displayBookings(pastDueBookings, currentFilter);
                })
                .catch(error => {
                    console.error("Error updating extended booking:", error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: 'Failed to extend booking.',
                        confirmButtonColor: '#dc3545'
                    });
                });
        } else {
            // For other statuses, just save the history
            saveBookingHistory(updateData)
                .then(() => {
                    // Update local status map for immediate UI update
                    bookingStatusMap[booking.bookingId] = newStatus;

                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: `Booking status updated to ${newStatus}`,
                        confirmButtonColor: '#28a745'
                    });

                    // Hide modal
                    const bookingModal = bootstrap.Modal.getInstance(document.getElementById('bookingDetailsModal'));
                    bookingModal.hide();

                    // Refresh the counts and display
                    updateStatusCounts();
                    displayBookings(pastDueBookings, currentFilter);
                })
                .catch(error => {
                    console.error("Error saving booking history:", error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: 'Failed to update booking status.',
                        confirmButtonColor: '#dc3545'
                    });
                });
        }
    }

    // Function to save booking history to database
    function saveBookingHistory(historyData) {
        return fetch("http://localhost:8080/api/v1/booking-history/save", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify(historyData)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to save booking history");
                }
                return response.text();
            });
    }

    // Add click event listeners to status cards
    document.addEventListener("DOMContentLoaded", function() {
        document.querySelectorAll('.status-card').forEach(card => {
            card.addEventListener('click', function() {
                const status = this.dataset.status;
                currentFilter = status;
                displayBookings(pastDueBookings, status);
            });
        });

        // Initialize with all bookings
        fetchPastDueBookings();
    });
</script>
</body>
</html>