<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: 0.3s;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .card:hover {
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }
        .card-header {
            background-color: #f8f9fa;
            font-weight: bold;
            border-radius: 10px 10px 0 0 !important;
        }
        .payment-status-pending {
            color: #fd7e14;
        }
        .payment-status-completed {
            color: #198754;
        }
        .payment-status-failed {
            color: #dc3545;
        }
        .summary-card {
            border-left: 4px solid #0d6efd;
        }
        .chart-container {
            height: 300px;
        }
        .action-btn {
            margin-right: 5px;
        }
        .form-label {
            font-weight: 500;
        }
        .pagination {
            justify-content: center;
        }
    </style>
</head>
<body>


<div class="dashboard-container mt-4">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="fas fa-credit-card me-2"></i>Payment Management</h2>
            <p class="text-muted">Manage all payment transactions for service bookings</p>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPaymentModal">
                <i class="fas fa-plus me-1"></i> New Payment
            </button>
        </div>
    </div>

    <!-- Payment Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card summary-card h-100">
                <div class="card-body">
                    <h5 class="card-title">Total Payments</h5>
                    <h2 class="mt-3 mb-3" id="totalPayments">0</h2>
                    <p class="text-muted">Overall payment transactions</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card summary-card h-100" style="border-left-color: #198754;">
                <div class="card-body">
                    <h5 class="card-title">Completed</h5>
                    <h2 class="mt-3 mb-3 text-success" id="completedPayments">0</h2>
                    <p class="text-muted">Successfully processed payments</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card summary-card h-100" style="border-left-color: #fd7e14;">
                <div class="card-body">
                    <h5 class="card-title">Pending</h5>
                    <h2 class="mt-3 mb-3 text-warning" id="pendingPayments">0</h2>
                    <p class="text-muted">Awaiting processing payments</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card summary-card h-100" style="border-left-color: #dc3545;">
                <div class="card-body">
                    <h5 class="card-title">Failed</h5>
                    <h2 class="mt-3 mb-3 text-danger" id="failedPayments">0</h2>
                    <p class="text-muted">Unsuccessful payment attempts</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Method Chart -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    Payment Methods Distribution
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="paymentMethodChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    Recent Activity
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush" id="recentActivityList">
                        <li class="list-group-item text-center text-muted">Loading recent activity...</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <input type="text" class="form-control" placeholder="Search payments..." id="searchPayment">
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="Completed">Completed</option>
                        <option value="Pending">Pending</option>
                        <option value="Failed">Failed</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="methodFilter">
                        <option value="">All Methods</option>
                        <option value="Credit Card">Credit Card</option>
                        <option value="Cash">Cash</option>
                        <option value="Online">Online</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="date" class="form-control" id="dateFilter">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-secondary w-100" id="resetFilters">
                        <i class="fas fa-undo me-1"></i> Reset
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payments Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Payment Transactions</span>
            <div>
                <button class="btn btn-sm btn-outline-secondary me-1" id="refreshBtn">
                    <i class="fas fa-sync-alt me-1"></i> Refresh
                </button>
                <button class="btn btn-sm btn-outline-secondary" id="exportBtn">
                    <i class="fas fa-file-export me-1"></i> Export
                </button>
            </div>
        </div>
        <div class="card-body table-responsive">
            <table class="table table-hover">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Booking ID</th>
                    <th>Date</th>
                    <th>Amount</th>
                    <th>Method</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="paymentsTableBody">
                <tr>
                    <td colspan="7" class="text-center">Loading payments...</td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="card-footer">
            <nav>
                <ul class="pagination" id="paymentPagination">
                    <li class="page-item disabled">
                        <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                    </li>
                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                    <li class="page-item disabled">
                        <a class="page-link" href="#">Next</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Add Payment Modal -->
<div class="modal fade" id="addPaymentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addPaymentForm">
                    <div class="mb-3">
                        <label for="bookingId" class="form-label">Booking ID</label>
                        <select class="form-select" id="bookingId" required>
                            <option value="">Select Booking</option>
                            <!-- Bookings will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="amount" class="form-label">Amount</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="amount" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="paymentMethod" class="form-label">Payment Method</label>
                        <select class="form-select" id="paymentMethod" required>
                            <option value="Credit Card">Credit Card</option>
                            <option value="Cash">Cash</option>
                            <option value="Online">Online</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="paymentStatus" class="form-label">Payment Status</label>
                        <select class="form-select" id="paymentStatus" required>
                            <option value="Pending">Pending</option>
                            <option value="Completed">Completed</option>
                            <option value="Failed">Failed</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="savePaymentBtn">Save Payment</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Payment Modal -->
<div class="modal fade" id="editPaymentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editPaymentForm">
                    <input type="hidden" id="editPaymentId">
                    <div class="mb-3">
                        <label for="editBookingId" class="form-label">Booking ID</label>
                        <select class="form-select" id="editBookingId" required>
                            <option value="">Select Booking</option>
                            <!-- Bookings will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editAmount" class="form-label">Amount</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="editAmount" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editPaymentMethod" class="form-label">Payment Method</label>
                        <select class="form-select" id="editPaymentMethod" required>
                            <option value="Credit Card">Credit Card</option>
                            <option value="Cash">Cash</option>
                            <option value="Online">Online</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editPaymentStatus" class="form-label">Payment Status</label>
                        <select class="form-select" id="editPaymentStatus" required>
                            <option value="Pending">Pending</option>
                            <option value="Completed">Completed</option>
                            <option value="Failed">Failed</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="updatePaymentBtn">Update Payment</button>
            </div>
        </div>
    </div>
</div>

<!-- Payment Details Modal -->
<div class="modal fade" id="paymentDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Payment Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="fw-bold">Payment Information</h6>
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td class="text-muted">Payment ID:</td>
                                <td id="detailPaymentId"></td>
                            </tr>
                            <tr>
                                <td class="text-muted">Date & Time:</td>
                                <td id="detailPaymentDate"></td>
                            </tr>
                            <tr>
                                <td class="text-muted">Amount:</td>
                                <td id="detailAmount"></td>
                            </tr>
                            <tr>
                                <td class="text-muted">Method:</td>
                                <td id="detailPaymentMethod"></td>
                            </tr>
                            <tr>
                                <td class="text-muted">Status:</td>
                                <td id="detailPaymentStatus"></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold">Booking Information</h6>
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td class="text-muted">Booking ID:</td>
                                <td id="detailBookingId"></td>
                            </tr>
                            <tr>
                                <td class="text-muted">Service:</td>
                                <td id="detailService"></td>
                            </tr>
                            <tr>
                                <td class="text-muted">Customer:</td>
                                <td id="detailCustomer"></td>
                            </tr>
                            <tr>
                                <td class="text-muted">Vehicle:</td>
                                <td id="detailVehicle"></td>
                            </tr>
                            <tr>
                                <td class="text-muted">Date:</td>
                                <td id="detailBookingDate"></td>
                            </tr>
                        </table>
                    </div>
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-primary" id="printReceiptBtn">
                        <i class="fas fa-print me-1"></i> Print Receipt
                    </button>
                    <div>
                        <button type="button" class="btn btn-outline-danger me-2" id="deletePaymentDetailBtn">
                            <i class="fas fa-trash me-1"></i> Delete
                        </button>
                        <button type="button" class="btn btn-primary" id="editPaymentDetailBtn">
                            <i class="fas fa-edit me-1"></i> Edit
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this payment? This action cannot be undone.</p>
                <input type="hidden" id="deletePaymentId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 5">
    <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="toastTitle">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            Operation successful.
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chart.js/3.9.1/chart.min.js"></script>
<script>
    // Base API URL
    const API_BASE_URL = 'http://localhost:8080/api/v1';
    let allPayments = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    let paymentMethodChart = null;

    let token = localStorage.getItem("authToken");

    // Initialize page
    $(document).ready(function() {
        loadPayments();
        loadBookings();
        loadPaymentSummary();
        loadPaymentMethodStats();
        setupEventListeners();
    });

    // Setup event listeners
    function setupEventListeners() {
        // Save payment
        $('#savePaymentBtn').click(savePayment);

        // Update payment
        $('#updatePaymentBtn').click(updatePayment);

        // Confirm delete
        $('#confirmDeleteBtn').click(deletePayment);

        // Detail buttons action
        $('#editPaymentDetailBtn').click(function() {
            const paymentId = $('#detailPaymentId').text();
            prepareEditPayment(paymentId);
            $('#paymentDetailsModal').modal('hide');
            $('#editPaymentModal').modal('show');
        });

        $('#deletePaymentDetailBtn').click(function() {
            const paymentId = $('#detailPaymentId').text();
            $('#deletePaymentId').val(paymentId);
            $('#paymentDetailsModal').modal('hide');
            $('#deleteConfirmModal').modal('show');
        });

        // Print receipt
        $('#printReceiptBtn').click(printReceipt);

        // Search and filters
        $('#searchPayment').on('input', applyFilters);
        $('#statusFilter').change(applyFilters);
        $('#methodFilter').change(applyFilters);
        $('#dateFilter').change(applyFilters);
        $('#resetFilters').click(resetFilters);

        // Refresh button
        $('#refreshBtn').click(function() {
            loadPayments();
            loadPaymentSummary();
            loadPaymentMethodStats();
            showToast('Data Refreshed', 'Payment data has been refreshed successfully.');
        });

        // Export button
        $('#exportBtn').click(exportPaymentsData);
    }

    // Load all payments
    function loadPayments() {
        $.ajax({
            url: `${API_BASE_URL}/payment/getAll`,
            type: "GET",
            headers: {
                "Authorization": "Bearer " + token
            },
            success: function(data) {
                allPayments = data;
                displayPayments(allPayments);
                updatePagination();
            },
            error: function(xhr, status, error) {
                console.error('Error loading payments:', error);
                showToast('Error', 'Failed to load payments. Please try again.', 'error');
            }
        });
    }

    // Load bookings for dropdown
    function loadBookings() {
        $.ajax({
            url: `${API_BASE_URL}/booking/getAll`,
            type: "GET",
            headers: {
                "Authorization": "Bearer " + token
            },
            success: function(data) {
                const bookingIdSelect = $('#bookingId');
                const editBookingIdSelect = $('#editBookingId');

                // Clear existing options
                bookingIdSelect.html('<option value="">Select Booking</option>');
                editBookingIdSelect.html('<option value="">Select Booking</option>');

                // Add new options
                data.forEach(booking => {
                    const option = `<option value="${booking.bookingId}">Booking #${booking.bookingId} - ${new Date(booking.bookingDate).toLocaleDateString()}</option>`;
                    bookingIdSelect.append(option);
                    editBookingIdSelect.append(option);
                });
            },
            error: function(xhr, status, error) {
                console.error('Error loading bookings:', error);
            }
        });
    }

    // Load payment summary statistics
    function loadPaymentSummary() {
        $.ajax({
            url: `${API_BASE_URL}/payment/summary`,
            type: "GET",
            headers: {
                "Authorization": "Bearer " + token
            },
            success: function(data) {
                $('#totalPayments').text(data.totalPayments);
                $('#completedPayments').text(data.completedPayments);
                $('#pendingPayments').text(data.pendingPayments);
                $('#failedPayments').text(data.failedPayments);

                // Load recent activity
                loadRecentActivity();
            },
            error: function(xhr, status, error) {
                console.error('Error loading payment summary:', error);
            }
        });
    }

    // Load recent activity for the recent activity list
    function loadRecentActivity() {
        // This could be a separate endpoint or we can use the most recent payments
        if (allPayments.length > 0) {
            const recentPayments = [...allPayments].sort((a, b) =>
                new Date(b.paymentDate) - new Date(a.paymentDate)).slice(0, 5);

            const activityList = $('#recentActivityList');
            activityList.empty();

            recentPayments.forEach(payment => {
                const date = new Date(payment.paymentDate);
                const formattedDate = date.toLocaleDateString() + ' ' +
                    date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                let statusIcon = 'fa-clock text-warning';
                if (payment.paymentStatus === 'Completed') {
                    statusIcon = 'fa-check-circle text-success';
                } else if (payment.paymentStatus === 'Failed') {
                    statusIcon = 'fa-times-circle text-danger';
                }

                const listItem = `
                    <li class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">Payment #${payment.paymentId}</h6>
                            <small>${formattedDate}</small>
                        </div>
                        <p class="mb-1">
                            <i class="fas ${statusIcon} me-1"></i>
                            ${payment.paymentStatus} payment of $${payment.amount.toFixed(2)} via ${payment.paymentMethod}
                        </p>
                        <small class="text-muted">For Booking #${payment.bookingId}</small>
                    </li>
                `;
                activityList.append(listItem);
            });
        } else {
            $('#recentActivityList').html('<li class="list-group-item text-center">No recent activity</li>');
        }
    }

    // Load payment method statistics for chart
    function loadPaymentMethodStats() {
        $.ajax({
            url: `${API_BASE_URL}/payment/method-stats`,
            type: "GET",
            headers: {
                "Authorization": "Bearer " + token
            },
            success: function(data) {
                renderPaymentMethodChart(data);
            },
            error: function(xhr, status, error) {
                console.error('Error loading payment method stats:', error);
            }
        });
    }

    // Render chart for payment methods
    function renderPaymentMethodChart(data) {
        const ctx = document.getElementById('paymentMethodChart').getContext('2d');

        // Destroy existing chart if any
        if (paymentMethodChart) {
            paymentMethodChart.destroy();
        }

        const labels = Object.keys(data);
        const values = Object.values(data);

        // Generate random colors
        const backgroundColors = labels.map((_, i) => {
            const colors = ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'];
            return colors[i % colors.length];
        });

        paymentMethodChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: backgroundColors,
                    hoverBackgroundColor: backgroundColors.map(color => {
                        return color.replace(')', ', 0.8)').replace('rgb', 'rgba');
                    }),
                    hoverBorderColor: "rgba(234, 236, 244, 1)",
                }]
            },
            options: {
                maintainAspectRatio: false,
                tooltips: {
                    backgroundColor: "rgb(255,255,255)",
                    bodyFontColor: "#858796",
                    borderColor: '#dddfeb',
                    borderWidth: 1,
                    xPadding: 15,
                    yPadding: 15,
                    displayColors: false,
                    caretPadding: 10,
                },
                legend: {
                    display: true,
                    position: 'bottom'
                },
                cutoutPercentage: 70,
            },
        });
    }

    // Display payments in table (continuation of the function)
    function displayPayments(payments) {
        const tableBody = $('#paymentsTableBody');
        tableBody.empty();

        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const paymentsToShow = payments.slice(startIndex, endIndex);

        if (paymentsToShow.length === 0) {
            tableBody.html(`
            <tr>
                <td colspan="7" class="text-center">No payments found</td>
            </tr>
        `);
            return;
        }

        paymentsToShow.forEach(payment => {
            const date = new Date(payment.paymentDate);
            const formattedDate = date.toLocaleDateString();

            let statusClass = '';
            if (payment.paymentStatus === 'Completed') {
                statusClass = 'payment-status-completed';
            } else if (payment.paymentStatus === 'Pending') {
                statusClass = 'payment-status-pending';
            } else if (payment.paymentStatus === 'Failed') {
                statusClass = 'payment-status-failed';
            }

            const row = `
            <tr>
                <td>${payment.paymentId}</td>
                <td>${payment.bookingId}</td>
                <td>${formattedDate}</td>
                <td>$${payment.amount.toFixed(2)}</td>
                <td>${payment.paymentMethod}</td>
                <td><span class="${statusClass}">${payment.paymentStatus}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-primary action-btn" onclick="viewPaymentDetails('${payment.paymentId}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-warning action-btn" onclick="prepareEditPayment('${payment.paymentId}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger action-btn" onclick="prepareDeletePayment('${payment.paymentId}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
            tableBody.append(row);
        });
    }

    // Update pagination based on filtered payments
    function updatePagination() {
        const totalPages = Math.ceil(allPayments.length / itemsPerPage);
        const pagination = $('#paymentPagination');
        pagination.empty();

        // Previous button
        const prevBtn = `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">Previous</a>
        </li>
    `;
        pagination.append(prevBtn);

        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            const pageBtn = `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
            </li>
        `;
            pagination.append(pageBtn);
        }

        // Next button
        const nextBtn = `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">Next</a>
        </li>
    `;
        pagination.append(nextBtn);
    }

    // Change current page
    function changePage(page) {
        currentPage = page;
        displayPayments(allPayments);
    }

    // View payment details
    function viewPaymentDetails(paymentId) {
        const payment = allPayments.find(p => p.paymentId == paymentId);
        if (!payment) return;

        // Set payment details
        $('#detailPaymentId').text(payment.paymentId);
        $('#detailPaymentDate').text(new Date(payment.paymentDate).toLocaleString());
        $('#detailAmount').text(`$${payment.amount.toFixed(2)}`);
        $('#detailPaymentMethod').text(payment.paymentMethod);

        let statusClass = '';
        if (payment.paymentStatus === 'Completed') {
            statusClass = 'text-success';
        } else if (payment.paymentStatus === 'Pending') {
            statusClass = 'text-warning';
        } else if (payment.paymentStatus === 'Failed') {
            statusClass = 'text-danger';
        }

        $('#detailPaymentStatus').html(`<span class="${statusClass}">${payment.paymentStatus}</span>`);
        $('#detailBookingId').text(payment.bookingId);

        // Get booking details (this would ideally be part of the payment details API)
        $.ajax({
            url: `${API_BASE_URL}/booking/getById/${payment.bookingId}`,
            type: "GET",
            headers: {
                "Authorization": "Bearer " + token
            },
            success: function(booking) {
                $('#detailService').text(booking.serviceName || 'N/A');
                $('#detailCustomer').text(booking.customerName || 'N/A');
                $('#detailVehicle').text(booking.vehicleInfo || 'N/A');
                $('#detailBookingDate').text(new Date(booking.bookingDate).toLocaleDateString());
            },
            error: function() {
                $('#detailService').text('N/A');
                $('#detailCustomer').text('N/A');
                $('#detailVehicle').text('N/A');
                $('#detailBookingDate').text('N/A');
            }
        });

        // Show modal
        $('#paymentDetailsModal').modal('show');
    }

    // Prepare edit payment
    function prepareEditPayment(paymentId) {
        const payment = allPayments.find(p => p.paymentId == paymentId);
        if (!payment) return;

        $('#editPaymentId').val(payment.paymentId);
        $('#editBookingId').val(payment.bookingId);
        $('#editAmount').val(payment.amount);
        $('#editPaymentMethod').val(payment.paymentMethod);
        $('#editPaymentStatus').val(payment.paymentStatus);

        $('#editPaymentModal').modal('show');
    }

    // Save new payment
    function savePayment() {
        const paymentData = {
            bookingId: $('#bookingId').val(),
            amount: parseFloat($('#amount').val()),
            paymentMethod: $('#paymentMethod').val(),
            paymentStatus: $('#paymentStatus').val(),
            paymentDate: new Date()
        };

        $.ajax({
            url: `${API_BASE_URL}/payment/save`,
            type: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            },
            data: JSON.stringify(paymentData),
            success: function() {
                $('#addPaymentModal').modal('hide');
                $('#addPaymentForm')[0].reset();
                loadPayments();
                loadPaymentSummary();
                loadPaymentMethodStats();
                showToast('Success', 'Payment saved successfully.');
            },
            error: function(xhr, status, error) {
                console.error('Error saving payment:', error);
                showToast('Error', 'Failed to save payment. Please try again.', 'error');
            }
        });
    }

    // Update existing payment
    function updatePayment() {
        const paymentData = {
            paymentId: $('#editPaymentId').val(),
            bookingId: $('#editBookingId').val(),
            amount: parseFloat($('#editAmount').val()),
            paymentMethod: $('#editPaymentMethod').val(),
            paymentStatus: $('#editPaymentStatus').val()
        };

        $.ajax({
            url: `${API_BASE_URL}/payment/update`,
            type: "PUT",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            },
            data: JSON.stringify(paymentData),
            success: function() {
                $('#editPaymentModal').modal('hide');
                loadPayments();
                loadPaymentSummary();
                loadPaymentMethodStats();
                showToast('Success', 'Payment updated successfully.');
            },
            error: function(xhr, status, error) {
                console.error('Error updating payment:', error);
                showToast('Error', 'Failed to update payment. Please try again.', 'error');
            }
        });
    }

    // Prepare delete payment
    function prepareDeletePayment(paymentId) {
        $('#deletePaymentId').val(paymentId);
        $('#deleteConfirmModal').modal('show');
    }

    // Delete payment
    function deletePayment() {
        const paymentId = $('#deletePaymentId').val();

        $.ajax({
            url: `${API_BASE_URL}/payment/delete/${paymentId}`,
            type: "DELETE",
            headers: {
                "Authorization": "Bearer " + token
            },
            success: function() {
                $('#deleteConfirmModal').modal('hide');
                loadPayments();
                loadPaymentSummary();
                loadPaymentMethodStats();
                showToast('Success', 'Payment deleted successfully.');
            },
            error: function(xhr, status, error) {
                console.error('Error deleting payment:', error);
                showToast('Error', 'Failed to delete payment. Please try again.', 'error');
            }
        });
    }

    // Apply filters to payments
    function applyFilters() {
        const searchTerm = $('#searchPayment').val().toLowerCase();
        const statusFilter = $('#statusFilter').val();
        const methodFilter = $('#methodFilter').val();
        const dateFilter = $('#dateFilter').val();

        let filteredPayments = [...allPayments];

        // Apply search filter
        if (searchTerm) {
            filteredPayments = filteredPayments.filter(payment =>
                payment.paymentId.toString().includes(searchTerm) ||
                payment.bookingId.toString().includes(searchTerm) ||
                payment.amount.toString().includes(searchTerm)
            );
        }

        // Apply status filter
        if (statusFilter) {
            filteredPayments = filteredPayments.filter(payment =>
                payment.paymentStatus === statusFilter
            );
        }

        // Apply method filter
        if (methodFilter) {
            filteredPayments = filteredPayments.filter(payment =>
                payment.paymentMethod === methodFilter
            );
        }

        // Apply date filter
        if (dateFilter) {
            const filterDate = new Date(dateFilter);
            filteredPayments = filteredPayments.filter(payment => {
                const paymentDate = new Date(payment.paymentDate);
                return paymentDate.toDateString() === filterDate.toDateString();
            });
        }

        // Reset to first page and display filtered payments
        currentPage = 1;
        displayPayments(filteredPayments);
        updatePagination();
    }

    // Reset all filters
    function resetFilters() {
        $('#searchPayment').val('');
        $('#statusFilter').val('');
        $('#methodFilter').val('');
        $('#dateFilter').val('');

        currentPage = 1;
        displayPayments(allPayments);
        updatePagination();
    }

    // Print receipt
    function printReceipt() {
        const paymentId = $('#detailPaymentId').text();
        const payment = allPayments.find(p => p.paymentId == paymentId);

        if (!payment) return;

        const receiptContent = `
        <html>
        <head>
            <title>Payment Receipt #${payment.paymentId}</title>
            <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 20px; }
                .header { text-align: center; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 20px; }
                .receipt-info { border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 20px; }
                table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
                .footer { text-align: center; margin-top: 30px; font-size: 0.9em; color: #666; }
                .total { font-weight: bold; font-size: 1.2em; }
            </style>
        </head>
        <body>
            <div class="header">
                <h2>Auto Service Center</h2>
                <p>123 Service Road, Cityville • (555) 123-4567</p>
            </div>
            <div class="receipt-info">
                <p><strong>Receipt #:</strong> ${payment.paymentId}</p>
                <p><strong>Date:</strong> ${new Date(payment.paymentDate).toLocaleDateString()}</p>
                <p><strong>Booking ID:</strong> ${payment.bookingId}</p>
                <p><strong>Payment Method:</strong> ${payment.paymentMethod}</p>
                <p><strong>Status:</strong> ${payment.paymentStatus}</p>
            </div>
            <table>
                <tr>
                    <th>Description</th>
                    <th>Amount</th>
                </tr>
                <tr>
                    <td>Auto Service (Booking #${payment.bookingId})</td>
                    <td>$${payment.amount.toFixed(2)}</td>
                </tr>
                <tr class="total">
                    <td>Total</td>
                    <td>$${payment.amount.toFixed(2)}</td>
                </tr>
            </table>
            <div class="footer">
                <p>Thank you for your business!</p>
                <p>This is computer generated receipt and requires no signature.</p>
            </div>
        </body>
        </html>
    `;

        const printWindow = window.open('', '_blank');
        printWindow.document.open();
        printWindow.document.write(receiptContent);
        printWindow.document.close();

        setTimeout(() => {
            printWindow.print();
        }, 500);
    }

    // Export payments data to CSV
    function exportPaymentsData() {
        let csv = 'Payment ID,Booking ID,Date,Amount,Method,Status\n';

        allPayments.forEach(payment => {
            const date = new Date(payment.paymentDate).toLocaleDateString();
            csv += `${payment.paymentId},${payment.bookingId},"${date}",${payment.amount.toFixed(2)},"${payment.paymentMethod}","${payment.paymentStatus}"\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);

        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', 'payment_data.csv');
        link.style.visibility = 'hidden';

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Show toast notification
    function showToast(title, message, type = 'success') {
        $('#toastTitle').text(title);
        $('#toastMessage').text(message);

        const toast = $('#notificationToast');
        const toastInstance = new bootstrap.Toast(toast);

        if (type === 'error') {
            toast.addClass('bg-danger text-white');
        } else {
            toast.removeClass('bg-danger text-white');
        }

        toastInstance.show();
    }

    // Check authentication
    function checkAuth() {
        if (!token) {
            window.location.href = "login.html";
        }
    }

    // Logout function
    $('#logoutBtn').click(function() {
        localStorage.removeItem("authToken");
        window.location.href = "login.html";
    });

    // Check authentication on page load
    checkAuth();
</script>
</body>
</html>

